trigger:
    branches:
        include:
            - main
            - feature/*

variables:
    - group: 'aks-nonprod'

stages:
    - stage: Terraform
      displayName: 'Terraform Pipeline'
      jobs:
          - job: CreateAks
            displayName: 'Creating aks'
            pool:
                vmImage: 'ubuntu-latest'
            container:
                image: ballastacr.azurecr.io/terraform:1.0.0
                endpoint: ballastacr
            steps:
                - checkout: self
                  persistCredentials: true
                  clean: true

                - task: CmdLine@2
                  displayName: 'Az Authentication'
                  inputs:
                      script: |
                          az login --service-principal --username $(TF_VAR_client_id) --password $(TF_VAR_client_secret) --tenant $(TF_VAR_tenant_id)
                          export TF_VAR_client_id="$(TF_VAR_client_id)"
                          export TF_VAR_client_secret="$(TF_VAR_client_secret)"
                          export TF_VAR_tenant_id="$(TF_VAR_tenant_id)"

                - task: CmdLine@2
                  displayName: 'Terraform init'
                  inputs:
                      script: |
                          cd 2.0_non_prod
                          terraform init

                - task: CmdLine@2
                  displayName: 'Terraform validate'
                  inputs:
                      script: |
                          cd 2.0_non_prod
                          terraform validate

                - task: CmdLine@2
                  displayName: 'Terraform plan'
                  inputs:
                      script: |
                          env
                          cd 2.0_non_prod
                          terraform plan -out=tfplan

                - task: CmdLine@2
                  displayName: 'Terraform apply'
                  inputs:
                      script: |
                          cd 2.0_non_prod
                          terraform apply tfplan
                  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
